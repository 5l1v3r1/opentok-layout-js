/*!
 *  opentok-layout-js (http://github.com/aullman/opentok-layout-js)
 *
 *  Automatic layout of video elements (publisher and subscriber) minimising
 *  white-space for the OpenTok on WebRTC API.
 *
 *  @Author: Adam Ullman (http://github.com/aullman)
 *  @Copyright (c) 2014 Adam Ullman
 *  @License: Released under the MIT license (http://opensource.org/licenses/MIT)
**/
if("undefined"==typeof module||"undefined"==typeof module.exports)exports=window;else var window=null;!function(t){var i=function(i,e,o,a,r,n){var g={left:e+"px",top:o+"px",width:a+"px",height:r+"px"},d=function(){var t=i.querySelector(".OT_root");if(t){var e=t.style.width;t.style.width=a+"px",t.style.width=e||""}};n&&t?(console.log("animate"),t(i).stop(),t(i).animate(g,n.duration||200,n.easing||"swing",function(){d(),n.complete&&n.complete.call(this)})):OT.$.css(i,g),d()},e=function(t,i){var e=OT.$.css(t,i);return e?parseInt(e,10):0},o=function(){return(1e8*Math.random()).toFixed(0)},a=function(t){var i=OT.$.height(t);return i?parseInt(i,10):0},r=function(t){var i=OT.$.width(t);return i?parseInt(i,10):0},n=function(t,o,a,r,n,g,d,l,s){var h,f=t.length,u=function(t,i){for(var e,r,n,g,d,l,s,u,b=1;f>=b;b++){var R=b,c=Math.ceil(f/R);s=Math.floor(a/c),l=Math.floor(o/R),u=s/l,u>i?(u=i,s=l*u):t>u&&(u=t,l=s/u);var p=l*s*f;(void 0===e||p>e)&&(e=p,g=s,d=l,r=R,n=c)}return{maxArea:e,targetCols:r,targetRows:n,targetHeight:g,targetWidth:d,ratio:h}};if(g){var b=t.length>0&&t[0].querySelector("video");h=b&&b.videoHeight&&b.videoWidth?u(b.videoHeight/b.videoWidth,b.videoHeight/b.videoWidth):u(.75,.75)}else h=u(d,l);for(var R=h.targetRows*h.targetCols-f,c=R*h.targetWidth/2,p=(h.targetRows-1)*h.targetCols,v=(a-h.targetRows*h.targetHeight)/2,m=(o-h.targetCols*h.targetWidth)/2,x=0,y=0,w=0;w<t.length;w++){var T=t[w];w%h.targetCols===0?(x=m,w==p&&(x+=c),y+=0===w?v:h.targetHeight):x+=h.targetWidth,OT.$.css(T,"position","absolute");var M=h.targetWidth-e(T,"paddingLeft")-e(T,"paddingRight")-e(T,"marginLeft")-e(T,"marginRight")-e(T,"borderLeft")-e(T,"borderRight"),O=h.targetHeight-e(T,"paddingTop")-e(T,"paddingBottom")-e(T,"marginTop")-e(T,"marginBottom")-e(T,"borderTop")-e(T,"borderBottom");i(T,x+r,y+n,M,O,s)}},g=function(t){return"none"!==OT.$.css(t,"display")},d=function(t,i,d){if("none"!==OT.$.css(t,"display")){var l=t.getAttribute("id");l||(l="OT_"+o(),t.setAttribute("id",l));var s=a(t)-e(t,"borderTop")-e(t,"borderBottom"),h=r(t)-e(t,"borderLeft")-e(t,"borderRight"),f=s/h,u=0,b=0,R=0,c=0,p=Array.prototype.filter.call(t.querySelectorAll("#"+l+">."+i.bigClass),g),v=Array.prototype.filter.call(t.querySelectorAll("#"+l+">*:not(."+i.bigClass+")"),g);if(p.length>0&&v.length>0){var m=p[0].querySelector("video");m&&m.videoHeight&&m.videoWidth?bigRatio=m.videoHeight/m.videoWidth:bigRatio=.75;var x,y;f>bigRatio?(x=h,y=Math.min(Math.floor(s*i.bigPercentage),h*bigRatio),b=y,R=s-b):(y=s,x=Math.min(h*i.bigPercentage,Math.floor(y/bigRatio)),u=x,c=h-u),i.bigFirst?(n(p,x,y,0,0,i.bigFixedRatio,i.bigMinRatio,i.bigMaxRatio,i.animate),n(v,h-u,s-b,u,b,i.fixedRatio,i.minRatio,i.maxRatio,i.animate)):(n(v,h-u,s-b,0,0,i.fixedRatio,i.minRatio,i.maxRatio,i.animate),n(p,x,y,c,R,i.bigFixedRatio,i.bigMinRatio,i.bigMaxRatio,i.animate))}else p.length>0&&0===v.length?n(p,h,s,0,0,i.bigFixedRatio,i.bigMinRatio,i.bigMaxRatio,i.animate):n(v,h-u,s-b,u,b,i.fixedRatio,i.minRatio,i.maxRatio,i.animate)}};exports.initLayoutContainer=function(t,i){return i=OT.$.defaults(i||{},{maxRatio:1.5,minRatio:9/16,fixedRatio:!1,animate:!1,bigClass:"OT_big",bigPercentage:.8,bigFixedRatio:!1,bigMaxRatio:1.5,bigMinRatio:9/16,bigFirst:!0}),t="string"==typeof t?OT.$(t):t,OT.onLoad(function(){d(t,i)}),{layout:d.bind(null,t,i)}}}(window&&window.hasOwnProperty("jQuery")?jQuery:void 0);