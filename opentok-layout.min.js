/*!
 *  opentok-layout-js (http://github.com/aullman/opentok-layout-js)
 *
 *  Automatic layout of video elements (publisher and subscriber) minimising
 *  white-space for the OpenTok on WebRTC API.
 *
 *  @Author: Adam Ullman (http://github.com/aullman)
 *  @Copyright (c) 2014 Adam Ullman
 *  @License: Released under the MIT license (http://opensource.org/licenses/MIT)
**/
("undefined"==typeof module||"undefined"==typeof module.exports)&&(exports=window),function(t){var i=function(i,e,o,a,r,n){var g={left:e+"px",top:o+"px",width:a+"px",height:r+"px"},d=function(){var t=i.querySelector(".OT_root");if(t){var e=t.style.width;t.style.width=a+"px",t.style.width=e||""}};n&&t?(console.log("animate"),t(i).stop(),t(i).animate(g,n.duration||200,n.easing||"swing",function(){d(),n.complete&&n.complete.call(this)})):(i.style.left=g.left,i.style.top=g.top,i.style.width=g.width,i.style.height=g.height),d()},e=function(t,i){var e=window.getComputedStyle(t)[i];return e?parseInt(e,10):0},o=function(){return(1e8*Math.random()).toFixed(0)},a=function(t){return t.clientHeight},r=function(t){return t.clientWidth},n=function(t,i){var e,o={};for(e in t)t.hasOwnProperty(e)&&(o[e]=t[e]);for(e in i)i.hasOwnProperty(e)&&!o.hasOwnProperty(e)&&(o[e]=i[e]);return o},g=function(t,o,a,r,n,g,d,l,h){var s,f=t.length,u=function(t,i){for(var e,r,n,g,d,l,h,u=1;f>=u;u++){var p=u,m=Math.ceil(f/p);h=Math.floor(a/m),l=Math.floor(o/p);var b=h/l;b>i?(b=i,h=l*b):t>b&&(b=t,l=h/b);var c=l*h*f;(void 0===e||c>e)&&(e=c,g=h,d=l,r=p,n=m)}return{maxArea:e,targetCols:r,targetRows:n,targetHeight:g,targetWidth:d,ratio:s}};if(g){var p=t.length>0&&t[0].querySelector("video");s=p&&p.videoHeight&&p.videoWidth?u(p.videoHeight/p.videoWidth,p.videoHeight/p.videoWidth):u(.75,.75)}else s=u(d,l);for(var m=s.targetRows*s.targetCols-f,b=m*s.targetWidth/2,c=(s.targetRows-1)*s.targetCols,v=(a-s.targetRows*s.targetHeight)/2,y=(o-s.targetCols*s.targetWidth)/2,R=0,x=0,w=0;w<t.length;w++){var M=t[w];w%s.targetCols===0?(R=y,w===c&&(R+=b),x+=0===w?v:s.targetHeight):R+=s.targetWidth,M.style.position="absolute";var C=s.targetWidth-e(M,"paddingLeft")-e(M,"paddingRight")-e(M,"marginLeft")-e(M,"marginRight")-e(M,"borderLeft")-e(M,"borderRight"),W=s.targetHeight-e(M,"paddingTop")-e(M,"paddingBottom")-e(M,"marginTop")-e(M,"marginBottom")-e(M,"borderTop")-e(M,"borderBottom");i(M,R+r,x+n,C,W,h)}},d=function(t){return"none"!==window.getComputedStyle(t).display},l=function(t,i){if(d(t)){var n=t.getAttribute("id");n||(n="OT_"+o(),t.setAttribute("id",n));var l,h=a(t)-e(t,"borderTop")-e(t,"borderBottom"),s=r(t)-e(t,"borderLeft")-e(t,"borderRight"),f=h/s,u=0,p=0,m=0,b=0,c=Array.prototype.filter.call(t.querySelectorAll("#"+n+">."+i.bigClass),d),v=Array.prototype.filter.call(t.querySelectorAll("#"+n+">*:not(."+i.bigClass+")"),d);if(c.length>0&&v.length>0){var y=c[0].querySelector("video");l=y&&y.videoHeight&&y.videoWidth?y.videoHeight/y.videoWidth:.75;var R,x;f>l?(R=s,x=Math.min(Math.floor(h*i.bigPercentage),s*l),p=x,m=h-p):(x=h,R=Math.min(s*i.bigPercentage,Math.floor(x/l)),u=R,b=s-u),i.bigFirst?(g(c,R,x,0,0,i.bigFixedRatio,i.bigMinRatio,i.bigMaxRatio,i.animate),g(v,s-u,h-p,u,p,i.fixedRatio,i.minRatio,i.maxRatio,i.animate)):(g(v,s-u,h-p,0,0,i.fixedRatio,i.minRatio,i.maxRatio,i.animate),g(c,R,x,b,m,i.bigFixedRatio,i.bigMinRatio,i.bigMaxRatio,i.animate))}else c.length>0&&0===v.length?g(c,s,h,0,0,i.bigFixedRatio,i.bigMinRatio,i.bigMaxRatio,i.animate):g(v,s-u,h-p,u,p,i.fixedRatio,i.minRatio,i.maxRatio,i.animate)}};exports.initLayoutContainer=function(t,i){return i=n(i||{},{maxRatio:1.5,minRatio:9/16,fixedRatio:!1,animate:!1,bigClass:"OT_big",bigPercentage:.8,bigFixedRatio:!1,bigMaxRatio:1.5,bigMinRatio:9/16,bigFirst:!0}),t="string"==typeof t?document.querySelector(t):t,l(t,i),{layout:l.bind(null,t,i)}}}(window.hasOwnProperty("jQuery")?jQuery:void 0);